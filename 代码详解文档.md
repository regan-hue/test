# Cornerstone.js + Vue 3 åŒ»å­¦å½±åƒæŸ¥çœ‹å™¨ - è¯¦ç»†ä»£ç è§£ææ–‡æ¡£

## ğŸ“š ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆä»‹ç»](#æŠ€æœ¯æ ˆä»‹ç»)
3. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
4. [æ ¸å¿ƒä»£ç é€è¡Œè§£æ](#æ ¸å¿ƒä»£ç é€è¡Œè§£æ)
5. [å¦‚ä½•ä¿®æ”¹é¡¹ç›®](#å¦‚ä½•ä¿®æ”¹é¡¹ç›®)

---

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Vue 3** å’Œ **Cornerstone.js** å¼€å‘çš„åŒ»å­¦å½±åƒï¼ˆDICOMï¼‰ä¸‰è§†å›¾æŸ¥çœ‹å™¨ã€‚å®ƒå¯ä»¥åŒæ—¶æ˜¾ç¤ºè½´å‘ï¼ˆAxialï¼‰ã€çŸ¢çŠ¶ï¼ˆSagittalï¼‰å’Œå† çŠ¶ï¼ˆCoronalï¼‰ä¸‰ä¸ªè§†å›¾ï¼Œå¹¶æ”¯æŒåå­—å‡†çº¿ï¼ˆCrosshairsï¼‰è”åŠ¨ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- ä» Orthanc DICOM æœåŠ¡å™¨åŠ è½½åŒ»å­¦å½±åƒ
- æ˜¾ç¤ºä¸‰ä¸ªæ­£äº¤è§†å›¾ï¼ˆè½´å‘ã€çŸ¢çŠ¶ã€å† çŠ¶ï¼‰
- åå­—å‡†çº¿å·¥å…·å®ç°ä¸‰ä¸ªè§†å›¾çš„è”åŠ¨
- æ”¯æŒå¹³ç§»ã€ç¼©æ”¾ã€çª—å®½çª—ä½è°ƒæ•´ç­‰åŸºæœ¬æ“ä½œ

---

## æŠ€æœ¯æ ˆä»‹ç»

### Vue 3 åŸºç¡€æ¦‚å¿µ

**Vue 3** æ˜¯ä¸€ä¸ªæ¸è¿›å¼ JavaScript æ¡†æ¶ï¼Œç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢ã€‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- **ç»„ä»¶ï¼ˆComponentï¼‰**ï¼šå¯å¤ç”¨çš„ä»£ç å—ï¼ŒåŒ…å«æ¨¡æ¿ã€è„šæœ¬å’Œæ ·å¼
- **å“åº”å¼æ•°æ®ï¼ˆReactiveï¼‰**ï¼šä½¿ç”¨ `ref()` æˆ– `reactive()` åˆ›å»ºçš„æ•°æ®ï¼Œå½“æ•°æ®æ”¹å˜æ—¶ï¼Œç•Œé¢è‡ªåŠ¨æ›´æ–°
- **ç”Ÿå‘½å‘¨æœŸé’©å­**ï¼š`onMounted()` ç»„ä»¶æŒ‚è½½åæ‰§è¡Œï¼Œ`onUnmounted()` ç»„ä»¶å¸è½½å‰æ‰§è¡Œ
- **Props**ï¼šçˆ¶ç»„ä»¶ä¼ é€’ç»™å­ç»„ä»¶çš„æ•°æ®

**å¸¸ç”¨ APIï¼š**
```javascript
import { ref, onMounted, onUnmounted } from 'vue'
// ref() - åˆ›å»ºå“åº”å¼å˜é‡
const count = ref(0)  // è®¿é—®å€¼ç”¨ count.value
// onMounted() - ç»„ä»¶æŒ‚è½½åæ‰§è¡Œ
onMounted(() => { console.log('ç»„ä»¶å·²æŒ‚è½½') })
```

### Cornerstone.js åŸºç¡€æ¦‚å¿µ

**Cornerstone.js** æ˜¯ç”¨äºåŒ»å­¦å½±åƒå¯è§†åŒ–çš„ JavaScript åº“ã€‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- **Viewportï¼ˆè§†å£ï¼‰**ï¼šæ˜¾ç¤ºåŒ»å­¦å½±åƒçš„å®¹å™¨
- **RenderingEngineï¼ˆæ¸²æŸ“å¼•æ“ï¼‰**ï¼šç®¡ç†æ‰€æœ‰è§†å£çš„æ¸²æŸ“
- **Volumeï¼ˆä½“ç§¯ï¼‰**ï¼š3D åŒ»å­¦å½±åƒæ•°æ®
- **Toolï¼ˆå·¥å…·ï¼‰**ï¼šäº¤äº’å·¥å…·ï¼Œå¦‚åå­—å‡†çº¿ã€å¹³ç§»ã€ç¼©æ”¾ç­‰
- **ToolGroupï¼ˆå·¥å…·ç»„ï¼‰**ï¼šç®¡ç†å¤šä¸ªå·¥å…·å’Œè§†å£

**åŸºæœ¬ä½¿ç”¨æµç¨‹ï¼š**
1. åˆå§‹åŒ– Cornerstone
2. åˆ›å»ºæ¸²æŸ“å¼•æ“
3. åˆ›å»ºè§†å£
4. åŠ è½½å½±åƒæ•°æ®
5. æ¸²æŸ“æ˜¾ç¤º

---

## é¡¹ç›®ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js              # åº”ç”¨å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ App.vue              # æ ¹ç»„ä»¶
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ CrosshairsViewer.vue  # ä¸»æŸ¥çœ‹å™¨ç»„ä»¶
â”œâ”€â”€ vite.config.js           # Vite æ„å»ºé…ç½®
â”œâ”€â”€ package.json             # é¡¹ç›®ä¾èµ–é…ç½®
â””â”€â”€ index.html               # HTML å…¥å£æ–‡ä»¶
```

---

## æ ¸å¿ƒä»£ç é€è¡Œè§£æ

### 1. main.js - åº”ç”¨å…¥å£

```javascript
import { createApp } from 'vue'  // ä» Vue å¯¼å…¥ createApp å‡½æ•°ï¼Œç”¨äºåˆ›å»º Vue åº”ç”¨å®ä¾‹
import App from './App.vue'      // å¯¼å…¥æ ¹ç»„ä»¶ App.vue

createApp(App).mount('#app')     // åˆ›å»ºåº”ç”¨å®ä¾‹ï¼ŒæŒ‚è½½åˆ° id ä¸º 'app' çš„ DOM å…ƒç´ ä¸Š
```

**è¯´æ˜ï¼š**
- `createApp()` æ˜¯ Vue 3 åˆ›å»ºåº”ç”¨çš„æ–¹å¼
- `.mount('#app')` å°†åº”ç”¨æŒ‚è½½åˆ°é¡µé¢ä¸Šçš„ `<div id="app"></div>` å…ƒç´ 

---

### 2. App.vue - æ ¹ç»„ä»¶

```vue
<template>
  <!-- Vue æ¨¡æ¿è¯­æ³•ï¼šå®šä¹‰ç»„ä»¶çš„ HTML ç»“æ„ -->
  <div id="app">
    <!-- ä½¿ç”¨ CrosshairsViewer ç»„ä»¶ï¼Œå¹¶ä¼ é€’ä¸¤ä¸ªå±æ€§ -->
    <CrosshairsViewer 
      :studyInstanceUID="studyInstanceUID"    <!-- : è¡¨ç¤ºç»‘å®šåŠ¨æ€æ•°æ® -->
      :seriesInstanceUID="seriesInstanceUID"  <!-- å°†å“åº”å¼å˜é‡ä¼ é€’ç»™å­ç»„ä»¶ -->
    />
  </div>
</template>

<script setup>
// <script setup> æ˜¯ Vue 3 çš„ç»„åˆå¼ API è¯­æ³•ï¼Œæ›´ç®€æ´
import { ref } from 'vue'                    // å¯¼å…¥ ref å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå“åº”å¼å˜é‡
import CrosshairsViewer from './components/CrosshairsViewer.vue'  // å¯¼å…¥å­ç»„ä»¶

// DICOM é…ç½®å‚æ•°
// ref() åˆ›å»ºå“åº”å¼å˜é‡ï¼Œè¿™äº›å€¼æ”¹å˜æ—¶ï¼Œç•Œé¢ä¼šè‡ªåŠ¨æ›´æ–°
const studyInstanceUID = ref('1.2.826.0.1.3680043.2.109.5.20220519102622656.1699758078.1')
const seriesInstanceUID = ref('1.3.12.2.1107.5.1.4.73336.30000022051900071431600050933')
</script>

<style>
/* å…¨å±€æ ·å¼ï¼šé‡ç½®æ‰€æœ‰å…ƒç´ çš„é»˜è®¤æ ·å¼ */
* {
  margin: 0;        /* å¤–è¾¹è·è®¾ä¸º 0 */
  padding: 0;       /* å†…è¾¹è·è®¾ä¸º 0 */
  box-sizing: border-box;  /* ç›’æ¨¡å‹ï¼šå®½åº¦åŒ…å« padding å’Œ border */
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  /* è®¾ç½®å­—ä½“ï¼Œä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿå­—ä½“ */
}

#app {
  width: 100vw;     /* å®½åº¦ï¼š100% è§†å£å®½åº¦ */
  height: 100vh;    /* é«˜åº¦ï¼š100% è§†å£é«˜åº¦ */
  overflow: hidden; /* éšè—æº¢å‡ºå†…å®¹ */
}
</style>
```

**å…³é”®ç‚¹ï¼š**
- `:propName` æ˜¯ `v-bind:propName` çš„ç®€å†™ï¼Œç”¨äºåŠ¨æ€ç»‘å®šæ•°æ®
- `ref()` åˆ›å»ºå“åº”å¼å˜é‡ï¼Œè®¿é—®å€¼éœ€è¦ç”¨ `.value`
- `script setup` ä¸­å®šä¹‰çš„å˜é‡å¯ä»¥ç›´æ¥åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

---

### 3. CrosshairsViewer.vue - ä¸»æŸ¥çœ‹å™¨ç»„ä»¶ï¼ˆæ ¸å¿ƒï¼‰

#### 3.1 æ¨¡æ¿éƒ¨åˆ†ï¼ˆTemplateï¼‰

```vue
<template>
  <!-- æ ¹å®¹å™¨ï¼šåŒ…å«æ‰€æœ‰è§†å›¾ -->
  <div class="crosshairs-viewer">
    <!-- è§†å£å®¹å™¨ï¼šä½¿ç”¨ CSS Grid å¸ƒå±€æ˜¾ç¤ºä¸‰ä¸ªè§†å›¾ -->
    <div class="viewport-container">
      <!-- è½´å‘è§†å›¾ï¼šä»å¤´é¡¶å¾€ä¸‹çœ‹çš„æ¨ªåˆ‡é¢ -->
      <div ref="axialViewport" class="viewport">
        <!-- ref ç”¨äºåœ¨ JavaScript ä¸­è·å– DOM å…ƒç´ å¼•ç”¨ -->
        <div class="viewport-label">è½´å‘ (Axial)</div>  <!-- è§†å›¾æ ‡ç­¾ -->
      </div>
      <!-- çŸ¢çŠ¶è§†å›¾ï¼šä»ä¾§é¢çœ‹çš„çºµåˆ‡é¢ -->
      <div ref="sagittalViewport" class="viewport">
        <div class="viewport-label">çŸ¢çŠ¶ (Sagittal)</div>
      </div>
      <!-- å† çŠ¶è§†å›¾ï¼šä»å‰é¢çœ‹çš„çºµåˆ‡é¢ -->
      <div ref="coronalViewport" class="viewport">
        <div class="viewport-label">å† çŠ¶ (Coronal)</div>
      </div>
    </div>
    <!-- æ¡ä»¶æ¸²æŸ“ï¼šv-if è¡¨ç¤ºå½“ loading ä¸º true æ—¶æ˜¾ç¤º -->
    <div v-if="loading" class="loading">åŠ è½½ä¸­...</div>
    <!-- é”™è¯¯æç¤ºï¼šå½“ error æœ‰å€¼æ—¶æ˜¾ç¤º -->
    <div v-if="error" class="error">{{ error }}</div>
    <!-- {{ }} æ˜¯æ’å€¼è¯­æ³•ï¼Œæ˜¾ç¤ºå“åº”å¼å˜é‡çš„å€¼ -->
  </div>
</template>
```

**Vue æŒ‡ä»¤è¯´æ˜ï¼š**
- `ref="name"`ï¼šè·å– DOM å…ƒç´ å¼•ç”¨ï¼Œåœ¨ script ä¸­ç”¨ `name.value` è®¿é—®
- `v-if="condition"`ï¼šæ¡ä»¶æ¸²æŸ“ï¼Œæ¡ä»¶ä¸º true æ—¶æ˜¾ç¤ºå…ƒç´ 
- `{{ variable }}`ï¼šæ’å€¼è¯­æ³•ï¼Œæ˜¾ç¤ºå˜é‡å€¼

#### 3.2 è„šæœ¬éƒ¨åˆ†ï¼ˆScriptï¼‰- å¯¼å…¥å’Œé…ç½®

```javascript
<script setup>
// ========== Vue 3 å¯¼å…¥ ==========
import { ref, onMounted, onUnmounted } from 'vue'
// ref: åˆ›å»ºå“åº”å¼å˜é‡
// onMounted: ç»„ä»¶æŒ‚è½½åæ‰§è¡Œï¼ˆç±»ä¼¼ Vue 2 çš„ mountedï¼‰
// onUnmounted: ç»„ä»¶å¸è½½å‰æ‰§è¡Œï¼ˆç±»ä¼¼ Vue 2 çš„ beforeDestroyï¼‰

// ========== Cornerstone.js æ ¸å¿ƒåº“å¯¼å…¥ ==========
import * as cornerstone from '@cornerstonejs/core'
// å¯¼å…¥æ•´ä¸ª cornerstone å‘½åç©ºé—´ï¼Œç”¨äºé…ç½® DICOM åŠ è½½å™¨
import {
  init as cornerstoneInit,        // åˆå§‹åŒ–å‡½æ•°ï¼Œé‡å‘½åä¸º cornerstoneInit
  imageLoader,                     // å›¾åƒåŠ è½½å™¨ï¼Œç”¨äºæ³¨å†Œ DICOM å›¾åƒåŠ è½½æ–¹å¼
  getRenderingEngine,              // è·å–æ¸²æŸ“å¼•æ“å®ä¾‹
  RenderingEngine,                 // æ¸²æŸ“å¼•æ“ç±»ï¼Œç®¡ç†æ‰€æœ‰è§†å£
  Enums,                           // æšä¸¾å¸¸é‡ï¼ˆå¦‚ ViewportTypeã€OrientationAxisï¼‰
  volumeLoader,                    // ä½“ç§¯åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ 3D ä½“ç§¯æ•°æ®
  cache,                           // ç¼“å­˜ç®¡ç†ï¼Œç”¨äºæ¸…ç†èµ„æº
} from '@cornerstonejs/core'

// ========== DICOM å›¾åƒåŠ è½½å™¨å¯¼å…¥ ==========
import cornerstoneDICOMImageLoader from '@cornerstonejs/dicom-image-loader'
// ç”¨äºåŠ è½½ DICOM æ ¼å¼çš„åŒ»å­¦å½±åƒ
import dicomParser from 'dicom-parser'
// DICOM æ–‡ä»¶è§£æåº“ï¼Œç”¨äºè§£æ DICOM æ ‡ç­¾

// ========== Cornerstone å·¥å…·åº“å¯¼å…¥ ==========
import { 
  init as cornerstoneToolsInit,   // å·¥å…·åº“åˆå§‹åŒ–å‡½æ•°
  addTool,                         // æ·»åŠ å·¥å…·åˆ°å·¥å…·åº“
  ToolGroupManager,                // å·¥å…·ç»„ç®¡ç†å™¨ï¼Œç®¡ç†å¤šä¸ªå·¥å…·ç»„
  CrosshairsTool,                  // åå­—å‡†çº¿å·¥å…·ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
  Enums as ToolsEnums              // å·¥å…·æšä¸¾ï¼ˆå¦‚é¼ æ ‡æŒ‰é”®ç»‘å®šï¼‰
} from '@cornerstonejs/tools'

// ========== æµå¼å›¾åƒä½“ç§¯åŠ è½½å™¨å¯¼å…¥ ==========
import { cornerstoneStreamingImageVolumeLoader } from '@cornerstonejs/streaming-image-volume-loader'
// ç”¨äºæµå¼åŠ è½½å¤§å‹ 3D ä½“ç§¯æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®

// ========== Props å®šä¹‰ï¼ˆç»„ä»¶å±æ€§ï¼‰==========
const props = defineProps({
  studyInstanceUID: {              // ç ”ç©¶å®ä¾‹ UIDï¼ˆDICOM ä¸­ç ”ç©¶çš„å”¯ä¸€æ ‡è¯†ï¼‰
    type: String,                  // ç±»å‹ï¼šå­—ç¬¦ä¸²
    required: true,                // å¿…å¡«å±æ€§
  },
  seriesInstanceUID: {             // ç³»åˆ—å®ä¾‹ UIDï¼ˆDICOM ä¸­ç³»åˆ—çš„å”¯ä¸€æ ‡è¯†ï¼‰
    type: String,
    required: true,
  },
})
// defineProps å®šä¹‰ç»„ä»¶æ¥æ”¶çš„å±æ€§ï¼Œçˆ¶ç»„ä»¶é€šè¿‡ :propName="value" ä¼ é€’

// ========== å“åº”å¼å˜é‡å®šä¹‰ ==========
const axialViewport = ref(null)      // è½´å‘è§†å›¾çš„ DOM å…ƒç´ å¼•ç”¨
const sagittalViewport = ref(null)   // çŸ¢çŠ¶è§†å›¾çš„ DOM å…ƒç´ å¼•ç”¨
const coronalViewport = ref(null)    // å† çŠ¶è§†å›¾çš„ DOM å…ƒç´ å¼•ç”¨
const loading = ref(true)            // åŠ è½½çŠ¶æ€ï¼štrue è¡¨ç¤ºæ­£åœ¨åŠ è½½
const error = ref(null)              // é”™è¯¯ä¿¡æ¯ï¼šnull è¡¨ç¤ºæ— é”™è¯¯

// ========== æ¸²æŸ“å¼•æ“å’Œå·¥å…·ç»„ ID ==========
const renderingEngineId = 'myRenderingEngine'  // æ¸²æŸ“å¼•æ“çš„å”¯ä¸€æ ‡è¯†
const toolGroupId = 'myToolGroup'              // å·¥å…·ç»„çš„å”¯ä¸€æ ‡è¯†

// ========== DICOM æœåŠ¡å™¨é…ç½® ==========
const orthancUrl = 'http://192.168.1.3:18997'  // Orthanc DICOM æœåŠ¡å™¨åœ°å€
// æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®ä½ çš„æœåŠ¡å™¨åœ°å€ä¿®æ”¹
```

#### 3.3 ç»„ä»¶æŒ‚è½½æ—¶çš„åˆå§‹åŒ–ï¼ˆonMountedï¼‰

```javascript
onMounted(async () => {
  // onMounted: Vue ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œç»„ä»¶æŒ‚è½½åˆ° DOM åæ‰§è¡Œ
  // async: å¼‚æ­¥å‡½æ•°ï¼Œå› ä¸ºéœ€è¦ç­‰å¾…æ•°æ®åŠ è½½
  try {
    // ========== ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ– Cornerstone ==========
    await cornerstoneInit()          // åˆå§‹åŒ– Cornerstone æ ¸å¿ƒåº“
    await cornerstoneToolsInit()     // åˆå§‹åŒ–å·¥å…·åº“
    // await: ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œç¡®ä¿åˆå§‹åŒ–å®Œæˆåå†ç»§ç»­
    
    // ========== ç¬¬äºŒæ­¥ï¼šé…ç½® DICOM å›¾åƒåŠ è½½å™¨ ==========
    // è®¾ç½® cornerstone å®ä¾‹ - è¿™æ˜¯å¿…éœ€çš„ï¼
    cornerstoneDICOMImageLoader.external.cornerstone = cornerstone
    // å°† cornerstone å®ä¾‹èµ‹å€¼ç»™åŠ è½½å™¨çš„ external å±æ€§
    // è¿™æ ·åŠ è½½å™¨æ‰èƒ½ä½¿ç”¨ cornerstone çš„åŠŸèƒ½
    
    // è®¾ç½® dicomParser - è¿™ä¹Ÿæ˜¯å¿…éœ€çš„ï¼
    cornerstoneDICOMImageLoader.external.dicomParser = dicomParser
    // å°† dicomParser èµ‹å€¼ç»™åŠ è½½å™¨ï¼Œç”¨äºè§£æ DICOM æ–‡ä»¶
    
    // ========== ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ– Web Worker ç®¡ç†å™¨ ==========
    const config = {
      maxWebWorkers: navigator.hardwareConcurrency || 4,
      // æœ€å¤§ Web Worker æ•°é‡ï¼šä½¿ç”¨ CPU æ ¸å¿ƒæ•°ï¼Œé»˜è®¤ 4
      // Web Worker ç”¨äºåœ¨åå°çº¿ç¨‹è§£ç å›¾åƒï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
      startWebWorkersOnDemand: true,  // æŒ‰éœ€å¯åŠ¨ Workerï¼ŒèŠ‚çœèµ„æº
      taskConfiguration: {
        decodeTask: {                  // è§£ç ä»»åŠ¡é…ç½®
          initializeCodecsOnStartup: false,  // ä¸åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–ç¼–è§£ç å™¨
          usePDFJS: false,             // ä¸ä½¿ç”¨ PDF.jsï¼ˆDICOM ä¸éœ€è¦ï¼‰
          strict: false,               // ä¸ä¸¥æ ¼æ¨¡å¼ï¼Œå®¹é”™æ€§æ›´å¥½
        },
      },
    }
    
    if (cornerstoneDICOMImageLoader.webWorkerManager) {
      cornerstoneDICOMImageLoader.webWorkerManager.initialize(config)
      // åˆå§‹åŒ– Web Worker ç®¡ç†å™¨ï¼Œé…ç½®å¤šçº¿ç¨‹è§£ç 
    }
    
    // ========== ç¬¬å››æ­¥ï¼šæ³¨å†Œ DICOM å›¾åƒåŠ è½½å™¨ ==========
    if (cornerstoneDICOMImageLoader.register) {
      // å¦‚æœåŠ è½½å™¨æœ‰ register æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨
      cornerstoneDICOMImageLoader.register(imageLoader)
      // è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰åŠ è½½å™¨åˆ° imageLoader
    } else {
      // å¦‚æœæ²¡æœ‰ register æ–¹æ³•ï¼Œæ‰‹åŠ¨æ³¨å†Œ
      if (cornerstoneDICOMImageLoader.wadouri && cornerstoneDICOMImageLoader.wadouri.loadImage) {
        imageLoader.registerImageLoader('dicomweb', cornerstoneDICOMImageLoader.wadouri.loadImage)
        // æ³¨å†Œ WADO-URI åŠ è½½å™¨ï¼Œåè®®åä¸º 'dicomweb'
      } else if (cornerstoneDICOMImageLoader.loadImage) {
        imageLoader.registerImageLoader('dicomweb', cornerstoneDICOMImageLoader.loadImage)
        // æ³¨å†ŒåŠ è½½å™¨
      }
    }
    
    // ========== ç¬¬äº”æ­¥ï¼šæ³¨å†Œä½“ç§¯åŠ è½½å™¨ ==========
    volumeLoader.registerVolumeLoader('cornerstoneStreamingImageVolume', cornerstoneStreamingImageVolumeLoader)
    // æ³¨å†Œæµå¼ä½“ç§¯åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ 3D ä½“ç§¯æ•°æ®
    // 'cornerstoneStreamingImageVolume' æ˜¯åŠ è½½å™¨çš„åç§°
    
    // ========== ç¬¬å…­æ­¥ï¼šåˆ›å»ºæ¸²æŸ“å¼•æ“ ==========
    const renderingEngine = new RenderingEngine(renderingEngineId)
    // åˆ›å»ºæ¸²æŸ“å¼•æ“å®ä¾‹ï¼Œç®¡ç†æ‰€æœ‰è§†å£çš„æ¸²æŸ“
    
    // ========== ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºå·¥å…·ç»„ ==========
    const toolGroup = ToolGroupManager.createToolGroup(toolGroupId)
    // åˆ›å»ºå·¥å…·ç»„ï¼Œç”¨äºç®¡ç†å¤šä¸ªå·¥å…·å’Œè§†å£
    
    // ========== ç¬¬å…«æ­¥ï¼šæ·»åŠ åå­—å‡†çº¿å·¥å…· ==========
    addTool(CrosshairsTool)  // å°†åå­—å‡†çº¿å·¥å…·æ·»åŠ åˆ°å·¥å…·åº“
    toolGroup.addTool(CrosshairsTool.toolName)  // å°†å·¥å…·æ·»åŠ åˆ°å·¥å…·ç»„
    toolGroup.setToolActive(CrosshairsTool.toolName, {
      // æ¿€æ´»å·¥å…·ï¼Œè®¾ç½®é¼ æ ‡ç»‘å®š
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Primary }],
      // Primary è¡¨ç¤ºé¼ æ ‡å·¦é”®
    })
    
    // ========== ç¬¬ä¹æ­¥ï¼šæ·»åŠ å…¶ä»–äº¤äº’å·¥å…· ==========
    const { PanTool, WindowLevelTool, ZoomTool, StackScrollMouseWheelTool } = await import('@cornerstonejs/tools')
    // åŠ¨æ€å¯¼å…¥å…¶ä»–å·¥å…·ï¼ˆæŒ‰éœ€åŠ è½½ï¼Œå‡å°‘åˆå§‹åŒ…å¤§å°ï¼‰
    // PanTool: å¹³ç§»å·¥å…·
    // WindowLevelTool: çª—å®½çª—ä½è°ƒæ•´å·¥å…·ï¼ˆè°ƒæ•´å›¾åƒäº®åº¦å’Œå¯¹æ¯”åº¦ï¼‰
    // ZoomTool: ç¼©æ”¾å·¥å…·
    // StackScrollMouseWheelTool: é¼ æ ‡æ»šè½®æ»šåŠ¨åˆ‡ç‰‡å·¥å…·
    
    addTool(PanTool)              // æ·»åŠ å¹³ç§»å·¥å…·
    addTool(WindowLevelTool)      // æ·»åŠ çª—å®½çª—ä½å·¥å…·
    addTool(ZoomTool)             // æ·»åŠ ç¼©æ”¾å·¥å…·
    addTool(StackScrollMouseWheelTool)  // æ·»åŠ æ»šè½®æ»šåŠ¨å·¥å…·
    
    toolGroup.addTool(PanTool.toolName)              // æ·»åŠ åˆ°å·¥å…·ç»„
    toolGroup.addTool(WindowLevelTool.toolName)
    toolGroup.addTool(ZoomTool.toolName)
    toolGroup.addTool(StackScrollMouseWheelTool.toolName)
    
    // æ¿€æ´»å·¥å…·å¹¶è®¾ç½®é¼ æ ‡ç»‘å®š
    toolGroup.setToolActive(PanTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Auxiliary }],
      // Auxiliary è¡¨ç¤ºé¼ æ ‡ä¸­é”®ï¼ˆæ»šè½®æŒ‰ä¸‹ï¼‰
    })
    toolGroup.setToolActive(WindowLevelTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Secondary }],
      // Secondary è¡¨ç¤ºé¼ æ ‡å³é”®
    })
    toolGroup.setToolActive(ZoomTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Primary, modifierKey: ToolsEnums.KeyboardBindings.Shift }],
      // å·¦é”® + Shift é”®è§¦å‘ç¼©æ”¾
    })
    toolGroup.setToolActive(StackScrollMouseWheelTool.toolName, {
      bindings: [],  // ç©ºç»‘å®šï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤ç»‘å®šï¼ˆæ»šè½®ï¼‰
    })
    
    // ========== ç¬¬åæ­¥ï¼šè·å– DICOM å®ä¾‹åˆ—è¡¨ ==========
    const imageIds = await fetchInstances()
    // è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°è·å–æ‰€æœ‰ DICOM å›¾åƒçš„ ID åˆ—è¡¨
    
    if (!imageIds || imageIds.length === 0) {
      throw new Error('æœªæ‰¾åˆ°DICOMå®ä¾‹')
      // å¦‚æœæ²¡æœ‰å›¾åƒï¼ŒæŠ›å‡ºé”™è¯¯
    }
    
    // ========== ç¬¬åä¸€æ­¥ï¼šåˆ›å»ºè§†å£ ==========
    const viewportIds = {
      axial: 'axial-viewport',        // è½´å‘è§†å£ ID
      sagittal: 'sagittal-viewport',  // çŸ¢çŠ¶è§†å£ ID
      coronal: 'coronal-viewport',    // å† çŠ¶è§†å£ ID
    }
    
    // å®šä¹‰è§†å£é…ç½®æ•°ç»„
    const viewportInputArray = [
      {
        viewportId: viewportIds.axial,              // è§†å£å”¯ä¸€æ ‡è¯†
        type: Enums.ViewportType.ORTHOGRAPHIC,      // è§†å£ç±»å‹ï¼šæ­£äº¤æŠ•å½±
        element: axialViewport.value,                // DOM å…ƒç´ ï¼ˆref çš„å€¼ï¼‰
        defaultOptions: {
          orientation: Enums.OrientationAxis.AXIAL,  // é»˜è®¤æ–¹å‘ï¼šè½´å‘
        },
      },
      {
        viewportId: viewportIds.sagittal,
        type: Enums.ViewportType.ORTHOGRAPHIC,
        element: sagittalViewport.value,
        defaultOptions: {
          orientation: Enums.OrientationAxis.SAGITTAL,  // çŸ¢çŠ¶æ–¹å‘
        },
      },
      {
        viewportId: viewportIds.coronal,
        type: Enums.ViewportType.ORTHOGRAPHIC,
        element: coronalViewport.value,
        defaultOptions: {
          orientation: Enums.OrientationAxis.CORONAL,   // å† çŠ¶æ–¹å‘
        },
      },
    ]
    
    renderingEngine.setViewports(viewportInputArray)
    // åˆ›å»ºæ‰€æœ‰è§†å£
    
    // ========== ç¬¬åäºŒæ­¥ï¼šå°†è§†å£æ·»åŠ åˆ°å·¥å…·ç»„ ==========
    toolGroup.addViewport(viewportIds.axial, renderingEngineId)
    toolGroup.addViewport(viewportIds.sagittal, renderingEngineId)
    toolGroup.addViewport(viewportIds.coronal, renderingEngineId)
    // å°†è§†å£æ·»åŠ åˆ°å·¥å…·ç»„ï¼Œè¿™æ ·å·¥å…·æ‰èƒ½åœ¨è¿™äº›è§†å£ä¸Šå·¥ä½œ
    
    // ========== ç¬¬åä¸‰æ­¥ï¼šåŠ è½½ä½“ç§¯æ•°æ® ==========
    await loadVolume(renderingEngine, viewportIds, imageIds)
    // è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°åŠ è½½ 3D ä½“ç§¯æ•°æ®å¹¶æ˜¾ç¤º
    
    loading.value = false  // åŠ è½½å®Œæˆï¼Œè®¾ç½® loading ä¸º false
  } catch (err) {
    // æ•è·é”™è¯¯
    console.error('åˆå§‹åŒ–é”™è¯¯:', err)  // åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯
    error.value = err.message || 'åˆå§‹åŒ–å¤±è´¥'  // è®¾ç½®é”™è¯¯ä¿¡æ¯
    loading.value = false  // å³ä½¿å‡ºé”™ä¹Ÿè¦å…³é—­åŠ è½½çŠ¶æ€
  }
})
```

#### 3.4 è·å– DICOM å®ä¾‹å‡½æ•°ï¼ˆfetchInstancesï¼‰

```javascript
async function fetchInstances() {
  // å¼‚æ­¥å‡½æ•°ï¼šè·å– DICOM ç³»åˆ—ä¸­çš„æ‰€æœ‰å®ä¾‹ï¼ˆå›¾åƒï¼‰
  try {
    // ========== ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢ç³»åˆ— ==========
    const findResponse = await fetch('/tools/find', {
      // fetch: æµè§ˆå™¨åŸç”Ÿ APIï¼Œç”¨äºå‘é€ HTTP è¯·æ±‚
      // '/tools/find' ä¼šè¢« vite.config.js ä¸­çš„ä»£ç†è½¬å‘åˆ° Orthanc æœåŠ¡å™¨
      method: 'POST',  // POST è¯·æ±‚
      headers: {
        'Content-Type': 'application/json',  // è¯·æ±‚å¤´ï¼šJSON æ ¼å¼
      },
      body: JSON.stringify({
        // JSON.stringify: å°† JavaScript å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
        Level: 'Series',  // æŸ¥è¯¢çº§åˆ«ï¼šç³»åˆ—
        Query: {
          SeriesInstanceUID: props.seriesInstanceUID,  // æŸ¥è¯¢æ¡ä»¶ï¼šç³»åˆ— UID
        },
      }),
    })
    
    if (!findResponse.ok) {
      // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸï¼ˆçŠ¶æ€ç  200-299ï¼‰
      throw new Error(`æŸ¥è¯¢ç³»åˆ—å¤±è´¥: ${findResponse.status}`)
    }
    
    const seriesIds = await findResponse.json()
    // è§£æå“åº”ä¸º JSONï¼Œå¾—åˆ°ç³»åˆ— ID æ•°ç»„
    
    if (!seriesIds || seriesIds.length === 0) {
      throw new Error('æœªæ‰¾åˆ°æŒ‡å®šçš„ç³»åˆ—')
    }
    
    // ========== ç¬¬äºŒæ­¥ï¼šè·å–ç³»åˆ—è¯¦ç»†ä¿¡æ¯ ==========
    const seriesId = seriesIds[0]  // å–ç¬¬ä¸€ä¸ªç³»åˆ— ID
    const seriesResponse = await fetch(`/series/${seriesId}`)
    // è·å–ç³»åˆ—çš„è¯¦ç»†ä¿¡æ¯
    
    if (!seriesResponse.ok) {
      throw new Error(`è·å–ç³»åˆ—ä¿¡æ¯å¤±è´¥: ${seriesResponse.status}`)
    }
    
    const seriesData = await seriesResponse.json()
    // è§£æç³»åˆ—æ•°æ®
    
    // ========== ç¬¬ä¸‰æ­¥ï¼šè·å–å®ä¾‹åˆ—è¡¨ ==========
    const instanceIds = seriesData.Instances || []
    // ä»ç³»åˆ—æ•°æ®ä¸­æå–å®ä¾‹ ID æ•°ç»„
    
    if (instanceIds.length === 0) {
      throw new Error('ç³»åˆ—ä¸­æ²¡æœ‰æ‰¾åˆ°å®ä¾‹')
    }
    
    // ========== ç¬¬å››æ­¥ï¼šè·å–æ¯ä¸ªå®ä¾‹çš„å…ƒæ•°æ®å¹¶æ’åº ==========
    const instancesWithMetadata = await Promise.all(
      // Promise.all: ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆ
      instanceIds.map(async (instanceId) => {
        // map: éå†æ•°ç»„ï¼Œå¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œå‡½æ•°
        try {
          // è·å–å®ä¾‹çš„æ ‡ç­¾ï¼ˆDICOM å…ƒæ•°æ®ï¼‰
          const tagsResponse = await fetch(`/instances/${instanceId}/tags?simplify`)
          // ?simplify å‚æ•°ï¼šç®€åŒ–æ ‡ç­¾æ ¼å¼
          if (!tagsResponse.ok) {
            console.warn(`æ— æ³•è·å–å®ä¾‹ ${instanceId} çš„æ ‡ç­¾`)
            // å¦‚æœå¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼
            return { 
              instanceId, 
              imageId: `wadouri:/instances/${instanceId}/file`, 
              position: null, 
              sliceLocation: null, 
              instanceNumber: null 
            }
          }
          
          const tags = await tagsResponse.json()
          // è§£ææ ‡ç­¾æ•°æ®
          
          // æå–å…³é”®æ’åºå­—æ®µ
          // ImagePositionPatient (0020,0032): å›¾åƒåœ¨æ‚£è€…åæ ‡ç³»ä¸­çš„ä½ç½®
          // SliceLocation (0020,1041): åˆ‡ç‰‡ä½ç½®
          // InstanceNumber (0020,0013): å®ä¾‹ç¼–å·ï¼ˆå¤‡ç”¨ï¼‰
          const imagePositionPatient = tags['0020,0032'] || tags['ImagePositionPatient']
          const sliceLocation = tags['0020,1041'] || tags['SliceLocation']
          const instanceNumber = tags['0020,0013'] || tags['InstanceNumber']
          
          // è§£æ ImagePositionPatientï¼ˆæ ¼å¼é€šå¸¸æ˜¯ "x\\y\\z"ï¼‰
          let position = null
          if (imagePositionPatient && typeof imagePositionPatient === 'string') {
            const coords = imagePositionPatient.split('\\').map(Number)
            // split('\\'): æŒ‰åæ–œæ åˆ†å‰²å­—ç¬¦ä¸²
            // map(Number): å°†å­—ç¬¦ä¸²æ•°ç»„è½¬æ¢ä¸ºæ•°å­—æ•°ç»„
            if (coords.length >= 3 && !coords.some(isNaN)) {
              // æ£€æŸ¥æ˜¯å¦æœ‰ 3 ä¸ªåæ ‡ä¸”éƒ½æ˜¯æœ‰æ•ˆæ•°å­—
              position = coords
            }
          }
          
          return {
            instanceId,                                    // å®ä¾‹ ID
            imageId: `wadouri:/instances/${instanceId}/file`,  // å›¾åƒ IDï¼ˆç”¨äºåŠ è½½ï¼‰
            position,                                      // 3D ä½ç½®åæ ‡
            sliceLocation: sliceLocation ? Number(sliceLocation) : null,  // åˆ‡ç‰‡ä½ç½®
            instanceNumber: instanceNumber ? Number(instanceNumber) : null,  // å®ä¾‹ç¼–å·
          }
        } catch (err) {
          console.warn(`å¤„ç†å®ä¾‹ ${instanceId} æ—¶å‡ºé”™:`, err)
          return { instanceId, imageId: `wadouri:/instances/${instanceId}/file`, position: null, sliceLocation: null, instanceNumber: null }
        }
      })
    )
    
    // ========== ç¬¬äº”æ­¥ï¼šæŒ‰ç…§ç©ºé—´ä½ç½®æ’åº ==========
    instancesWithMetadata.sort((a, b) => {
      // sort: æ•°ç»„æ’åºå‡½æ•°ï¼Œè¿”å›è´Ÿæ•°è¡¨ç¤º a åœ¨å‰ï¼Œæ­£æ•°è¡¨ç¤º b åœ¨å‰
      // ä¼˜å…ˆä½¿ç”¨ ImagePositionPatient çš„ Z åæ ‡ï¼ˆé€šå¸¸æ˜¯è½´å‘ä½ç½®ï¼‰
      if (a.position && b.position && a.position.length >= 3 && b.position.length >= 3) {
        // å¯¹äºè½´å‘è§†å›¾ï¼Œä½¿ç”¨ Z åæ ‡ï¼›å¯¹äºçŸ¢çŠ¶è§†å›¾ï¼Œä½¿ç”¨ X åæ ‡ï¼›å¯¹äºå† çŠ¶è§†å›¾ï¼Œä½¿ç”¨ Y åæ ‡
        // é€šå¸¸è½´å‘è§†å›¾ä½¿ç”¨ Z åæ ‡æ’åº
        const zDiff = a.position[2] - b.position[2]  // Z åæ ‡å·®å€¼
        if (Math.abs(zDiff) > 0.001) {
          // å¦‚æœå·®å€¼å¤§äº 0.001ï¼ŒæŒ‰ Z åæ ‡æ’åº
          return zDiff
        }
      }
      
      // å¦‚æœæ²¡æœ‰ ImagePositionPatientï¼Œä½¿ç”¨ SliceLocation
      if (a.sliceLocation !== null && b.sliceLocation !== null) {
        const sliceDiff = a.sliceLocation - b.sliceLocation
        if (Math.abs(sliceDiff) > 0.001) {
          return sliceDiff
        }
      }
      
      // æœ€åä½¿ç”¨ InstanceNumber ä½œä¸ºå¤‡ç”¨æ’åº
      if (a.instanceNumber !== null && b.instanceNumber !== null) {
        return a.instanceNumber - b.instanceNumber
      }
      
      // å¦‚æœéƒ½æ²¡æœ‰ï¼Œä¿æŒåŸé¡ºåº
      return 0
    })
    
    // ========== ç¬¬å…­æ­¥ï¼šæå–æ’åºåçš„ imageIds ==========
    const imageIds = instancesWithMetadata.map(item => item.imageId)
    // map: æå–æ¯ä¸ªå®ä¾‹çš„ imageIdï¼Œç”Ÿæˆæ–°çš„æ•°ç»„
    
    console.log(`å·²åŠ è½½ ${imageIds.length} ä¸ªå®ä¾‹ï¼Œå·²æŒ‰ç©ºé—´ä½ç½®æ’åº`)
    
    return imageIds  // è¿”å›æ’åºåçš„å›¾åƒ ID æ•°ç»„
  } catch (err) {
    console.error('è·å–å®ä¾‹å¤±è´¥:', err)
    throw err  // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
  }
}
```

#### 3.5 åŠ è½½ä½“ç§¯æ•°æ®å‡½æ•°ï¼ˆloadVolumeï¼‰

```javascript
async function loadVolume(renderingEngine, viewportIds, imageIds) {
  // å¼‚æ­¥å‡½æ•°ï¼šåŠ è½½ 3D ä½“ç§¯æ•°æ®å¹¶æ˜¾ç¤ºåœ¨è§†å£ä¸­
  try {
    // ========== ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ä½“ç§¯ ID ==========
    const volumeId = `cornerstoneStreamingImageVolume:volume-${props.seriesInstanceUID}`
    // ä½“ç§¯çš„å”¯ä¸€æ ‡è¯†ï¼Œæ ¼å¼ï¼šåŠ è½½å™¨åç§°:è‡ªå®šä¹‰ID
    // ä½¿ç”¨ç³»åˆ— UID ç¡®ä¿å”¯ä¸€æ€§
    
    // ========== ç¬¬äºŒæ­¥ï¼šåˆ›å»ºä½“ç§¯åŠ è½½å™¨ ==========
    const volume = await volumeLoader.createAndCacheVolume(volumeId, {
      // createAndCacheVolume: åˆ›å»ºä½“ç§¯å¹¶ç¼“å­˜
      imageIds,  // å›¾åƒ ID æ•°ç»„
    })
    // è¿™ä¼šåˆ›å»ºä¸€ä¸ªæµå¼ä½“ç§¯å¯¹è±¡ï¼Œä½†è¿˜æ²¡æœ‰åŠ è½½æ•°æ®
    
    // ========== ç¬¬ä¸‰æ­¥ï¼šåŠ è½½ä½“ç§¯æ•°æ® ==========
    await volume.load()
    // å¼€å§‹åŠ è½½æ‰€æœ‰å›¾åƒæ•°æ®ï¼ˆæµå¼åŠ è½½ï¼Œä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ï¼‰
    
    // ========== ç¬¬å››æ­¥ï¼šè·å–è§†å£å¯¹è±¡ ==========
    const axialViewport = renderingEngine.getViewport(viewportIds.axial)
    const sagittalViewport = renderingEngine.getViewport(viewportIds.sagittal)
    const coronalViewport = renderingEngine.getViewport(viewportIds.coronal)
    // ä»æ¸²æŸ“å¼•æ“è·å–è§†å£å¯¹è±¡ï¼Œç”¨äºæ“ä½œè§†å£
    
    // ========== ç¬¬äº”æ­¥ï¼šè®¾ç½®ä½“ç§¯åˆ°å„ä¸ªè§†å£ ==========
    axialViewport.setVolumes([{ volumeId }])
    sagittalViewport.setVolumes([{ volumeId }])
    coronalViewport.setVolumes([{ volumeId }])
    // setVolumes: è®¾ç½®è§†å£æ˜¾ç¤ºçš„ä½“ç§¯
    // ä¸‰ä¸ªè§†å£å…±äº«åŒä¸€ä¸ªä½“ç§¯æ•°æ®ï¼Œä½†æ˜¾ç¤ºä¸åŒçš„åˆ‡é¢
    
    // ========== ç¬¬å…­æ­¥ï¼šæ¸²æŸ“æ‰€æœ‰è§†å£ ==========
    renderingEngine.renderViewports([viewportIds.axial, viewportIds.sagittal, viewportIds.coronal])
    // è§¦å‘æ¸²æŸ“ï¼Œæ˜¾ç¤ºå›¾åƒ
  } catch (err) {
    console.error('åŠ è½½ä½“ç§¯å¤±è´¥:', err)
    throw err  // æŠ›å‡ºé”™è¯¯
  }
}
```

#### 3.6 ç»„ä»¶å¸è½½æ—¶çš„æ¸…ç†ï¼ˆonUnmountedï¼‰

```javascript
onUnmounted(() => {
  // onUnmounted: Vue ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œç»„ä»¶å¸è½½å‰æ‰§è¡Œ
  // æ¸…ç†èµ„æºï¼šé˜²æ­¢å†…å­˜æ³„æ¼
  try {
    // ========== ç¬¬ä¸€æ­¥ï¼šé”€æ¯æ¸²æŸ“å¼•æ“ ==========
    const renderingEngine = getRenderingEngine(renderingEngineId)
    // è·å–æ¸²æŸ“å¼•æ“å®ä¾‹
    if (renderingEngine) {
      renderingEngine.destroy()
      // é”€æ¯æ¸²æŸ“å¼•æ“ï¼Œé‡Šæ”¾æ‰€æœ‰è§†å£èµ„æº
    }
    
    // ========== ç¬¬äºŒæ­¥ï¼šé”€æ¯å·¥å…·ç»„ ==========
    ToolGroupManager.destroyToolGroup(toolGroupId)
    // é”€æ¯å·¥å…·ç»„ï¼Œé‡Šæ”¾å·¥å…·èµ„æº
    
    // ========== ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†ç¼“å­˜ ==========
    cache.purgeCache()
    // æ¸…ç† Cornerstone ç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜
  } catch (err) {
    console.error('æ¸…ç†èµ„æºå¤±è´¥:', err)
    // å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿä¸å½±å“ï¼Œåªæ˜¯è®°å½•é”™è¯¯
  }
})
```

#### 3.7 æ ·å¼éƒ¨åˆ†ï¼ˆStyleï¼‰

```vue
<style scoped>
/* scoped: æ ·å¼ä½œç”¨åŸŸï¼Œåªä½œç”¨äºå½“å‰ç»„ä»¶ï¼Œä¸ä¼šå½±å“å…¶ä»–ç»„ä»¶ */

.crosshairs-viewer {
  width: 100%;              /* å®½åº¦ï¼š100% çˆ¶å…ƒç´  */
  height: 100%;             /* é«˜åº¦ï¼š100% çˆ¶å…ƒç´  */
  display: flex;            /* Flexbox å¸ƒå±€ */
  flex-direction: column;   /* å‚ç›´æ–¹å‘æ’åˆ— */
}

.viewport-container {
  flex: 1;                  /* å æ®å‰©ä½™ç©ºé—´ */
  display: grid;            /* CSS Grid å¸ƒå±€ */
  grid-template-columns: repeat(2, 1fr);  /* 2 åˆ—ï¼Œæ¯åˆ—ç­‰å®½ */
  grid-template-rows: repeat(2, 1fr);    /* 2 è¡Œï¼Œæ¯è¡Œç­‰é«˜ */
  gap: 4px;                 /* ç½‘æ ¼é—´è· */
  padding: 4px;             /* å†…è¾¹è· */
}

.viewport {
  width: 100%;              /* å®½åº¦ 100% */
  height: 100%;             /* é«˜åº¦ 100% */
  background-color: #000;   /* èƒŒæ™¯è‰²ï¼šé»‘è‰²ï¼ˆåŒ»å­¦å½±åƒå¸¸ç”¨ï¼‰ */
  position: relative;       /* ç›¸å¯¹å®šä½ï¼Œç”¨äºå­å…ƒç´ ç»å¯¹å®šä½ */
}

/* ç¬¬ä¸€ä¸ªè§†å£ï¼šå·¦ä¸Šè§’ */
.viewport:nth-child(1) {
  grid-column: 1 / 2;       /* ç¬¬ 1 åˆ— */
  grid-row: 1 / 2;          /* ç¬¬ 1 è¡Œ */
}

/* ç¬¬äºŒä¸ªè§†å£ï¼šå³ä¸Šè§’ */
.viewport:nth-child(2) {
  grid-column: 2 / 3;       /* ç¬¬ 2 åˆ— */
  grid-row: 1 / 2;          /* ç¬¬ 1 è¡Œ */
}

/* ç¬¬ä¸‰ä¸ªè§†å£ï¼šä¸‹æ–¹ï¼ˆå æ®ä¸¤åˆ—ï¼‰ */
.viewport:nth-child(3) {
  grid-column: 1 / 3;       /* ç¬¬ 1-2 åˆ— */
  grid-row: 2 / 3;          /* ç¬¬ 2 è¡Œ */
}

.loading,
.error {
  position: absolute;       /* ç»å¯¹å®šä½ */
  top: 50%;                 /* è·ç¦»é¡¶éƒ¨ 50% */
  left: 50%;                /* è·ç¦»å·¦è¾¹ 50% */
  transform: translate(-50%, -50%);  /* å±…ä¸­ */
  padding: 20px;            /* å†…è¾¹è· */
  background: rgba(0, 0, 0, 0.8);  /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
  color: white;             /* ç™½è‰²æ–‡å­— */
  border-radius: 8px;       /* åœ†è§’ */
  z-index: 1000;            /* å±‚çº§ï¼šç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}

.error {
  background: rgba(200, 0, 0, 0.8);  /* é”™è¯¯æç¤ºï¼šçº¢è‰²èƒŒæ™¯ */
}

.viewport-label {
  position: absolute;       /* ç»å¯¹å®šä½ */
  top: 10px;                /* è·ç¦»é¡¶éƒ¨ 10px */
  left: 10px;               /* è·ç¦»å·¦è¾¹ 10px */
  color: white;             /* ç™½è‰²æ–‡å­— */
  background: rgba(0, 0, 0, 0.6);  /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
  padding: 4px 8px;         /* å†…è¾¹è· */
  border-radius: 4px;       /* åœ†è§’ */
  font-size: 12px;          /* å­—ä½“å¤§å° */
  z-index: 10;              /* å±‚çº§ */
  pointer-events: none;     /* ä¸å“åº”é¼ æ ‡äº‹ä»¶ */
}
</style>
```

---

### 4. vite.config.js - æ„å»ºé…ç½®

```javascript
import { defineConfig } from 'vite'  // å¯¼å…¥ Vite é…ç½®å‡½æ•°
import vue from '@vitejs/plugin-vue'  // å¯¼å…¥ Vue æ’ä»¶

export default defineConfig({
  plugins: [vue()],  // ä½¿ç”¨ Vue æ’ä»¶
  server: {
    port: 3002,       // å¼€å‘æœåŠ¡å™¨ç«¯å£
    open: true,       // è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    headers: {
      // â­ å…³é”®ï¼šæ·»åŠ å“åº”å¤´ä»¥å¯ç”¨ SharedArrayBuffer
      'Cross-Origin-Opener-Policy': 'same-origin',
      'Cross-Origin-Embedder-Policy': 'require-corp',
      // è¿™ä¸¤ä¸ªå“åº”å¤´æ˜¯å¿…éœ€çš„ï¼Œç”¨äºå¯ç”¨ SharedArrayBufferï¼ˆCornerstone éœ€è¦ï¼‰
    },
    proxy: {
      // é…ç½®ä»£ç†è§£å†³ CORS é—®é¢˜
      '/tools': {
        target: 'http://192.168.1.3:18997',  // ç›®æ ‡æœåŠ¡å™¨åœ°å€
        changeOrigin: true,                   // æ”¹å˜è¯·æ±‚å¤´ä¸­çš„ origin
        secure: false,                        // å…è®¸ HTTPS è¯ä¹¦æ— æ•ˆ
        ws: false,                            // ä¸ä»£ç† WebSocket
      },
      '/instances': { /* åŒä¸Š */ },
      '/series': { /* åŒä¸Š */ },
      '/wado': { /* åŒä¸Š */ },
    }
  }
})
```

**è¯´æ˜ï¼š**
- ä»£ç†é…ç½®å°† `/tools`ã€`/instances` ç­‰è¯·æ±‚è½¬å‘åˆ° Orthanc æœåŠ¡å™¨
- è¿™æ ·å¯ä»¥é¿å…æµè§ˆå™¨çš„ CORSï¼ˆè·¨åŸŸï¼‰é™åˆ¶

---

## å¦‚ä½•ä¿®æ”¹é¡¹ç›®

### 1. ä¿®æ”¹ DICOM æœåŠ¡å™¨åœ°å€

**ä½ç½®ï¼š** `src/components/CrosshairsViewer.vue` ç¬¬ 65 è¡Œ

```javascript
const orthancUrl = 'http://192.168.1.3:18997'  // ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€
```

**åŒæ—¶ä¿®æ”¹ï¼š** `vite.config.js` ä¸­çš„ `target` åœ°å€

```javascript
target: 'http://ä½ çš„æœåŠ¡å™¨åœ°å€:ç«¯å£'
```

### 2. ä¿®æ”¹ç ”ç©¶/ç³»åˆ— UID

**ä½ç½®ï¼š** `src/App.vue` ç¬¬ 15-16 è¡Œ

```javascript
const studyInstanceUID = ref('ä½ çš„ç ”ç©¶UID')
const seriesInstanceUID = ref('ä½ çš„ç³»åˆ—UID')
```

### 3. ä¿®æ”¹è§†å›¾å¸ƒå±€

**ä½ç½®ï¼š** `src/components/CrosshairsViewer.vue` æ ·å¼éƒ¨åˆ†

ä¿®æ”¹ `.viewport-container` çš„ `grid-template-columns` å’Œ `grid-template-rows` å¯ä»¥æ”¹å˜å¸ƒå±€ã€‚

### 4. æ·»åŠ æ–°å·¥å…·

**ä½ç½®ï¼š** `src/components/CrosshairsViewer.vue` onMounted ä¸­

```javascript
import { ä½ çš„å·¥å…· } from '@cornerstonejs/tools'
addTool(ä½ çš„å·¥å…·)
toolGroup.addTool(ä½ çš„å·¥å…·.toolName)
toolGroup.setToolActive(ä½ çš„å·¥å…·.toolName, {
  bindings: [{ mouseButton: ToolsEnums.MouseBindings.Primary }]
})
```

### 5. ä¿®æ”¹è§†å£æ•°é‡

1. åœ¨æ¨¡æ¿ä¸­æ·»åŠ æ–°çš„ `<div ref="æ–°è§†å£">`
2. åœ¨ script ä¸­æ·»åŠ  `const æ–°è§†å£ = ref(null)`
3. åœ¨ `viewportInputArray` ä¸­æ·»åŠ æ–°è§†å£é…ç½®
4. åœ¨ `loadVolume` ä¸­è®¾ç½®æ–°è§†å£çš„ä½“ç§¯

---

## æ€»ç»“

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Vue 3 å’Œ Cornerstone.js æ„å»ºåŒ»å­¦å½±åƒæŸ¥çœ‹å™¨ã€‚æ ¸å¿ƒæµç¨‹æ˜¯ï¼š

1. **åˆå§‹åŒ–** â†’ é…ç½® Cornerstone å’Œå·¥å…·
2. **è·å–æ•°æ®** â†’ ä» DICOM æœåŠ¡å™¨è·å–å›¾åƒåˆ—è¡¨
3. **åˆ›å»ºè§†å£** â†’ åˆ›å»ºä¸‰ä¸ªæ­£äº¤è§†å›¾
4. **åŠ è½½æ˜¾ç¤º** â†’ åŠ è½½ä½“ç§¯æ•°æ®å¹¶æ¸²æŸ“
5. **æ¸…ç†èµ„æº** â†’ ç»„ä»¶å¸è½½æ—¶é‡Šæ”¾å†…å­˜

**å…³é”®æ¦‚å¿µï¼š**
- Vue 3 çš„å“åº”å¼æ•°æ®å’Œç”Ÿå‘½å‘¨æœŸ
- Cornerstone.js çš„è§†å£ã€æ¸²æŸ“å¼•æ“ã€å·¥å…·ç»„
- DICOM æ•°æ®çš„è·å–å’Œæ’åº
- ä½“ç§¯æ•°æ®çš„åŠ è½½å’Œæ˜¾ç¤º

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ ç†è§£å’Œä¿®æ”¹é¡¹ç›®ï¼


<template>
  <div class="crosshairs-viewer">
    <div class="viewport-container">
      <div ref="axialViewport" class="viewport">
        <div class="viewport-label">è½´å‘ (Axial)</div>
      </div>
      <div ref="sagittalViewport" class="viewport">
        <div class="viewport-label">çŸ¢çŠ¶ (Sagittal)</div>
      </div>
      <div ref="coronalViewport" class="viewport">
        <div class="viewport-label">å† çŠ¶ (Coronal)</div>
      </div>
    </div>
    <div v-if="loading" class="loading">åŠ è½½ä¸­...</div>
    <div v-if="error" class="error">{{ error }}</div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import * as cornerstone from '@cornerstonejs/core'
import {
  init as cornerstoneInit,
  imageLoader,
  getRenderingEngine,
  RenderingEngine,
  Enums,
  volumeLoader,
  cache,
} from '@cornerstonejs/core'
import cornerstoneDICOMImageLoader from '@cornerstonejs/dicom-image-loader'
import dicomParser from 'dicom-parser'
import { 
  init as cornerstoneToolsInit, 
  addTool, 
  ToolGroupManager, 
  CrosshairsTool,
  Enums as ToolsEnums 
} from '@cornerstonejs/tools'
import { cornerstoneStreamingImageVolumeLoader } from '@cornerstonejs/streaming-image-volume-loader'

// Props å®šä¹‰
const props = defineProps({
  studyInstanceUID: {
    type: String,
    required: true,
  },
  seriesInstanceUID: {
    type: String,
    required: true,
  },
})

const axialViewport = ref(null)
const sagittalViewport = ref(null)
const coronalViewport = ref(null)
const loading = ref(true)
const error = ref(null)

const renderingEngineId = 'myRenderingEngine'
const toolGroupId = 'myToolGroup'

// DICOM é…ç½®
// OrthancæœåŠ¡å™¨åœ°å€ï¼ˆæ ¹æ®Orthanc DICOMwebæ–‡æ¡£ï¼‰
const orthancUrl = 'http://192.168.1.3:18997'

onMounted(async () => {
  try {
    // åˆå§‹åŒ– Cornerstone
    await cornerstoneInit()
    await cornerstoneToolsInit()
    
    // é…ç½® DICOM å›¾åƒåŠ è½½å™¨
    // è®¾ç½® cornerstone å®ä¾‹ - è¿™æ˜¯å¿…éœ€çš„ï¼
    cornerstoneDICOMImageLoader.external.cornerstone = cornerstone
    // è®¾ç½® dicomParser - è¿™ä¹Ÿæ˜¯å¿…éœ€çš„ï¼
    cornerstoneDICOMImageLoader.external.dicomParser = dicomParser
    
    // åˆå§‹åŒ– Web Worker ç®¡ç†å™¨
    const config = {
      maxWebWorkers: navigator.hardwareConcurrency || 4,
      startWebWorkersOnDemand: true,
      taskConfiguration: {
        decodeTask: {
          initializeCodecsOnStartup: false,
          usePDFJS: false,
          strict: false,
        },
      },
    }
    
    if (cornerstoneDICOMImageLoader.webWorkerManager) {
      cornerstoneDICOMImageLoader.webWorkerManager.initialize(config)
    }
    
    // æ³¨å†Œ DICOM å›¾åƒåŠ è½½å™¨
    // ä½¿ç”¨ register æ–¹æ³•è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰åŠ è½½å™¨
    if (cornerstoneDICOMImageLoader.register) {
      cornerstoneDICOMImageLoader.register(imageLoader)
    } else {
      // å¦‚æœæ²¡æœ‰ register æ–¹æ³•ï¼Œæ‰‹åŠ¨æ³¨å†Œ
      if (cornerstoneDICOMImageLoader.wadouri && cornerstoneDICOMImageLoader.wadouri.loadImage) {
        imageLoader.registerImageLoader('dicomweb', cornerstoneDICOMImageLoader.wadouri.loadImage)
      } else if (cornerstoneDICOMImageLoader.loadImage) {
        imageLoader.registerImageLoader('dicomweb', cornerstoneDICOMImageLoader.loadImage)
      }
    }
    
    // æ³¨å†Œä½“ç§¯åŠ è½½å™¨
    volumeLoader.registerVolumeLoader('cornerstoneStreamingImageVolume', cornerstoneStreamingImageVolumeLoader)

    // åˆ›å»ºæ¸²æŸ“å¼•æ“
    const renderingEngine = new RenderingEngine(renderingEngineId)

    // åˆ›å»ºå·¥å…·ç»„
    const toolGroup = ToolGroupManager.createToolGroup(toolGroupId)

    // æ·»åŠ  Crosshairs å·¥å…·
    addTool(CrosshairsTool)
    toolGroup.addTool(CrosshairsTool.toolName)
    toolGroup.setToolActive(CrosshairsTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Primary }],
    })

    // æ·»åŠ å…¶ä»–å¿…è¦çš„å·¥å…·
    const { PanTool, WindowLevelTool, ZoomTool, StackScrollMouseWheelTool } = await import('@cornerstonejs/tools')
    addTool(PanTool)
    addTool(WindowLevelTool)
    addTool(ZoomTool)
    addTool(StackScrollMouseWheelTool)

    toolGroup.addTool(PanTool.toolName)
    toolGroup.addTool(WindowLevelTool.toolName)
    toolGroup.addTool(ZoomTool.toolName)
    toolGroup.addTool(StackScrollMouseWheelTool.toolName)

    toolGroup.setToolActive(PanTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Auxiliary }],
    })
    toolGroup.setToolActive(WindowLevelTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Secondary }],
    })
    toolGroup.setToolActive(ZoomTool.toolName, {
      bindings: [{ mouseButton: ToolsEnums.MouseBindings.Primary, modifierKey: ToolsEnums.KeyboardBindings.Shift }],
    })
    toolGroup.setToolActive(StackScrollMouseWheelTool.toolName, {
      bindings: [],
    })

    // è·å–ç³»åˆ—ä¸­çš„æ‰€æœ‰å®ä¾‹
    const imageIds = await fetchInstances()
    
    if (!imageIds || imageIds.length === 0) {
      throw new Error('æœªæ‰¾åˆ°DICOMå®ä¾‹')
    }

    // åˆ›å»º viewport IDs
    const viewportIds = {
      axial: 'axial-viewport',
      sagittal: 'sagittal-viewport',
      coronal: 'coronal-viewport',
    }

    // åˆ›å»º Volume Viewportsï¼ˆç”¨äºå¤šå¹³é¢é‡å»ºï¼‰
    const viewportInputArray = [
      {
        viewportId: viewportIds.axial,
        type: Enums.ViewportType.ORTHOGRAPHIC,
        element: axialViewport.value,
        defaultOptions: {
          orientation: Enums.OrientationAxis.AXIAL,
        },
      },
      {
        viewportId: viewportIds.sagittal,
        type: Enums.ViewportType.ORTHOGRAPHIC,
        element: sagittalViewport.value,
        defaultOptions: {
          orientation: Enums.OrientationAxis.SAGITTAL,
        },
      },
      {
        viewportId: viewportIds.coronal,
        type: Enums.ViewportType.ORTHOGRAPHIC,
        element: coronalViewport.value,
        defaultOptions: {
          orientation: Enums.OrientationAxis.CORONAL,
        },
      },
    ]

    renderingEngine.setViewports(viewportInputArray)

    // å°† viewports æ·»åŠ åˆ°å·¥å…·ç»„
    toolGroup.addViewport(viewportIds.axial, renderingEngineId)
    toolGroup.addViewport(viewportIds.sagittal, renderingEngineId)
    toolGroup.addViewport(viewportIds.coronal, renderingEngineId)

    // åŠ è½½ä½“ç§¯æ•°æ®
    await loadVolume(renderingEngine, viewportIds, imageIds)

    loading.value = false
  } catch (err) {
    console.error('åˆå§‹åŒ–é”™è¯¯:', err)
    error.value = err.message || 'åˆå§‹åŒ–å¤±è´¥'
    loading.value = false
  }
})

async function fetchInstances() {
  try {
    // Orthanc API: å…ˆé€šè¿‡SeriesInstanceUIDæŸ¥è¯¢æ‰¾åˆ°ç³»åˆ—
    // ä½¿ç”¨tools/findæ¥å£æŸ¥è¯¢
    const findResponse = await fetch('/tools/find', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        Level: 'Series',
        Query: {
          SeriesInstanceUID: props.seriesInstanceUID,
        },
      }),
    })

    if (!findResponse.ok) {
      throw new Error(`æŸ¥è¯¢ç³»åˆ—å¤±è´¥: ${findResponse.status}`)
    }

    const seriesIds = await findResponse.json()

    if (!seriesIds || seriesIds.length === 0) {
      throw new Error('æœªæ‰¾åˆ°æŒ‡å®šçš„ç³»åˆ—')
    }

    // è·å–ç¬¬ä¸€ä¸ªç³»åˆ—çš„è¯¦ç»†ä¿¡æ¯
    const seriesId = seriesIds[0]
    const seriesResponse = await fetch(`/series/${seriesId}`)
    
    if (!seriesResponse.ok) {
      throw new Error(`è·å–ç³»åˆ—ä¿¡æ¯å¤±è´¥: ${seriesResponse.status}`)
    }

    const seriesData = await seriesResponse.json()
    
    // è·å–å®ä¾‹åˆ—è¡¨
    const instanceIds = seriesData.Instances || []
    
    if (instanceIds.length === 0) {
      throw new Error('ç³»åˆ—ä¸­æ²¡æœ‰æ‰¾åˆ°å®ä¾‹')
    }

    // è·å–æ¯ä¸ªå®ä¾‹çš„å…ƒæ•°æ®å¹¶æ’åº
    const instancesWithMetadata = await Promise.all(
      instanceIds.map(async (instanceId) => {
        try {
          // è·å–å®ä¾‹çš„æ ‡ç­¾ï¼ˆtagsï¼‰
          const tagsResponse = await fetch(`/instances/${instanceId}/tags?simplify`)
          if (!tagsResponse.ok) {
            console.warn(`æ— æ³•è·å–å®ä¾‹ ${instanceId} çš„æ ‡ç­¾`)
            return { instanceId, imageId: `wadouri:/instances/${instanceId}/file`, position: null, sliceLocation: null, instanceNumber: null }
          }
          
          const tags = await tagsResponse.json()
          
          // æå–å…³é”®æ’åºå­—æ®µ
          // ImagePositionPatient (0020,0032) - å›¾åƒåœ¨æ‚£è€…åæ ‡ç³»ä¸­çš„ä½ç½®
          // SliceLocation (0020,1041) - åˆ‡ç‰‡ä½ç½®
          // InstanceNumber (0020,0013) - å®ä¾‹ç¼–å·ï¼ˆå¤‡ç”¨ï¼‰
          const imagePositionPatient = tags['0020,0032'] || tags['ImagePositionPatient']
          const sliceLocation = tags['0020,1041'] || tags['SliceLocation']
          const instanceNumber = tags['0020,0013'] || tags['InstanceNumber']
          
          // è§£æ ImagePositionPatientï¼ˆæ ¼å¼é€šå¸¸æ˜¯ "x\\y\\z"ï¼‰
          let position = null
          if (imagePositionPatient && typeof imagePositionPatient === 'string') {
            const coords = imagePositionPatient.split('\\').map(Number)
            if (coords.length >= 3 && !coords.some(isNaN)) {
              position = coords
            }
          }
          
          return {
            instanceId,
            imageId: `wadouri:/instances/${instanceId}/file`,
            position,
            sliceLocation: sliceLocation ? Number(sliceLocation) : null,
            instanceNumber: instanceNumber ? Number(instanceNumber) : null,
          }
        } catch (err) {
          console.warn(`å¤„ç†å®ä¾‹ ${instanceId} æ—¶å‡ºé”™:`, err)
          return { instanceId, imageId: `wadouri:/instances/${instanceId}/file`, position: null, sliceLocation: null, instanceNumber: null }
        }
      })
    )

    // æŒ‰ç…§ç©ºé—´ä½ç½®æ’åº
    instancesWithMetadata.sort((a, b) => {
      // ä¼˜å…ˆä½¿ç”¨ ImagePositionPatient çš„ Z åæ ‡ï¼ˆé€šå¸¸æ˜¯è½´å‘ä½ç½®ï¼‰
      if (a.position && b.position && a.position.length >= 3 && b.position.length >= 3) {
        // å¯¹äºè½´å‘è§†å›¾ï¼Œä½¿ç”¨ Z åæ ‡ï¼›å¯¹äºçŸ¢çŠ¶è§†å›¾ï¼Œä½¿ç”¨ X åæ ‡ï¼›å¯¹äºå† çŠ¶è§†å›¾ï¼Œä½¿ç”¨ Y åæ ‡
        // é€šå¸¸è½´å‘è§†å›¾ä½¿ç”¨ Z åæ ‡æ’åº
        const zDiff = a.position[2] - b.position[2]
        if (Math.abs(zDiff) > 0.001) {
          return zDiff
        }
      }
      
      // å¦‚æœæ²¡æœ‰ ImagePositionPatientï¼Œä½¿ç”¨ SliceLocation
      if (a.sliceLocation !== null && b.sliceLocation !== null) {
        const sliceDiff = a.sliceLocation - b.sliceLocation
        if (Math.abs(sliceDiff) > 0.001) {
          return sliceDiff
        }
      }
      
      // æœ€åä½¿ç”¨ InstanceNumber ä½œä¸ºå¤‡ç”¨æ’åº
      if (a.instanceNumber !== null && b.instanceNumber !== null) {
        return a.instanceNumber - b.instanceNumber
      }
      
      // å¦‚æœéƒ½æ²¡æœ‰ï¼Œä¿æŒåŸé¡ºåº
      return 0
    })

    // æå–æ’åºåçš„ imageIds
    const imageIds = instancesWithMetadata.map(item => item.imageId)
    
    console.log(`å·²åŠ è½½ ${imageIds.length} ä¸ªå®ä¾‹ï¼Œå·²æŒ‰ç©ºé—´ä½ç½®æ’åº`)
    
    return imageIds
  } catch (err) {
    console.error('è·å–å®ä¾‹å¤±è´¥:', err)
    throw err
  }
}

async function loadVolume(renderingEngine, viewportIds, imageIds) {
  try {
    // å®šä¹‰ä½“ç§¯ID
    const volumeId = `cornerstoneStreamingImageVolume:volume-${props.seriesInstanceUID}`
    
    // åˆ›å»ºä½“ç§¯åŠ è½½å™¨
    const volume = await volumeLoader.createAndCacheVolume(volumeId, {
      imageIds,
    })

    // åŠ è½½ä½“ç§¯æ•°æ®
    await volume.load()

    // è®¾ç½®æ¯ä¸ªviewportæ˜¾ç¤ºä½“ç§¯
    const axialViewport = renderingEngine.getViewport(viewportIds.axial)
    const sagittalViewport = renderingEngine.getViewport(viewportIds.sagittal)
    const coronalViewport = renderingEngine.getViewport(viewportIds.coronal)

    // è®¾ç½®ä½“ç§¯åˆ°å„ä¸ªviewport
    axialViewport.setVolumes([{ volumeId }])
    sagittalViewport.setVolumes([{ volumeId }])
    coronalViewport.setVolumes([{ volumeId }])

    // æ¸²æŸ“æ‰€æœ‰viewport
    renderingEngine.renderViewports([viewportIds.axial, viewportIds.sagittal, viewportIds.coronal])
  } catch (err) {
    console.error('åŠ è½½ä½“ç§¯å¤±è´¥:', err)
    throw err
  }
}

onUnmounted(() => {
  // æ¸…ç†èµ„æº
  try {
    const renderingEngine = getRenderingEngine(renderingEngineId)
    if (renderingEngine) {
      renderingEngine.destroy()
    }
    ToolGroupManager.destroyToolGroup(toolGroupId)
    
    // æ¸…ç†ç¼“å­˜
    cache.purgeCache()
  } catch (err) {
    console.error('æ¸…ç†èµ„æºå¤±è´¥:', err)
  }
})
</script>

<style scoped>
.crosshairs-viewer {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.viewport-container {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, 1fr);
  gap: 4px;
  padding: 4px;
}

.viewport {
  width: 100%;
  height: 100%;
  background-color: #000;
  position: relative;
}

.viewport:nth-child(1) {
  grid-column: 1 / 2;
  grid-row: 1 / 2;
}

.viewport:nth-child(2) {
  grid-column: 2 / 3;
  grid-row: 1 / 2;
}

.viewport:nth-child(3) {
  grid-column: 1 / 3;
  grid-row: 2 / 3;
}

.loading,
.error {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 20px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border-radius: 8px;
  z-index: 1000;
}

.error {
  background: rgba(200, 0, 0, 0.8);
}

.viewport-label {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
  background: rgba(0, 0, 0, 0.6);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  z-index: 10;
  pointer-events: none;
}
</style>




















import { createApp } from 'vue'
import App from './App.vue'

createApp(App).mount('#app')









<template>
  <div id="app">
    <CrosshairsViewer 
      :studyInstanceUID="studyInstanceUID"
      :seriesInstanceUID="seriesInstanceUID"
    />
  </div>
</template>

<script setup>
import { ref } from 'vue'
import CrosshairsViewer from './components/CrosshairsViewer.vue'

// DICOM é…ç½®å‚æ•°
const studyInstanceUID = ref('1.2.826.0.1.3680043.2.109.5.20220519102622656.1699758078.1')
const seriesInstanceUID = ref('1.3.12.2.1107.5.1.4.73336.30000022051900071431600050933')
</script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

#app {
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}
</style>



